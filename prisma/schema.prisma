// =============================================================================
// Sprintify NPD — FMCG New Product Development Agile Platform
// =============================================================================
// Hybrid Agile: Stage-Gate + Scrum for R&D, Marketing, Packaging, Quality teams.
// Hierarchy: Organization > Program > Project > Feature (Stage) > UserStory > Task
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// =============================================================================
// Auth & Identity
// =============================================================================

model User {
  id         String      @id @default(cuid())
  supabaseId String      @unique @map("supabase_id")
  email      String      @unique
  name       String?
  avatarUrl  String?     @map("avatar_url")
  department Department?
  createdAt  DateTime    @default(now()) @map("created_at")
  updatedAt  DateTime    @updatedAt @map("updated_at")

  memberships     Membership[]
  assignedStories UserStory[]   @relation("StoryAssignee")
  reportedStories UserStory[]   @relation("StoryReporter")
  assignedTasks   Task[]        @relation("TaskAssignee")
  comments        Comment[]
  activities      Activity[]
  attachments     Attachment[]

  // Planning Poker
  hostedSessions       EstimationSession[]     @relation("SessionHost")
  estimationParticipations EstimationParticipant[]

  @@map("users")
}

// =============================================================================
// Organization & Tenancy
// =============================================================================

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  memberships      Membership[]
  programs         Program[]
  projects         Project[]
  labels           Label[]
  fieldDefinitions FieldDefinition[]

  @@map("organizations")
}

model Membership {
  id             String   @id @default(cuid())
  role           Role     @default(MEMBER)
  userId         String   @map("user_id")
  organizationId String   @map("organization_id")
  createdAt      DateTime @default(now()) @map("created_at")

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@map("memberships")
}

enum Role {
  ADMIN
  MEMBER
  VIEWER
}

enum Department {
  MARKETING
  R_AND_D
  PACKAGING
  QUALITY
  SUPPLY_CHAIN
  FINANCE
}

// =============================================================================
// Labels (Org-scoped, shared across programs)
// =============================================================================

model Label {
  id             String   @id @default(cuid())
  name           String
  color          String   @default("#6B7280")
  organizationId String   @map("organization_id")
  createdAt      DateTime @default(now()) @map("created_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  stories      StoryLabel[]

  @@unique([organizationId, name])
  @@map("labels")
}

model StoryLabel {
  storyId String @map("story_id")
  labelId String @map("label_id")

  story UserStory @relation(fields: [storyId], references: [id], onDelete: Cascade)
  label Label     @relation(fields: [labelId], references: [id], onDelete: Cascade)

  @@id([storyId, labelId])
  @@map("story_labels")
}

// =============================================================================
// Program (Top Level — e.g., "Biscuits Category", "Dairy Innovation")
// =============================================================================

model Program {
  id             String   @id @default(cuid())
  name           String
  description    String?  @db.Text
  organizationId String   @map("organization_id")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  projects     Project[]

  @@map("programs")
}

// =============================================================================
// Project (Epic — e.g., "New Protein Bar Launch")
// =============================================================================

model Project {
  id             String   @id @default(cuid())
  name           String
  key            String // e.g., "PROTBAR" for story IDs like PROTBAR-42
  description    String?  @db.Text
  programId      String?  @map("program_id")
  organizationId String   @map("organization_id")
  storyCounter   Int      @default(0) @map("story_counter")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  program            Program?            @relation(fields: [programId], references: [id], onDelete: SetNull)
  organization       Organization        @relation(fields: [organizationId], references: [id])
  features           Feature[]
  stories            UserStory[]
  boardColumns       BoardColumn[]
  sprints            Sprint[]
  estimationSessions EstimationSession[]

  @@unique([organizationId, key])
  @@map("projects")
}

// =============================================================================
// Feature (Stage — e.g., "Prototyping", "Packaging Design", "Lab Tests")
// =============================================================================

model Feature {
  id          String   @id @default(cuid())
  name        String
  description String?  @db.Text
  position    Int      @default(0)
  projectId   String   @map("project_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  project Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  stories UserStory[]

  @@map("features")
}

// =============================================================================
// Dynamic Field Definitions (The "Meta-Schema")
// Org-scoped: each company defines its own custom fields for stories.
// =============================================================================

model FieldDefinition {
  id             String    @id @default(cuid())
  name           String // e.g., "Regulatory Code", "Risk Value"
  fieldKey       String    @map("field_key") // machine-safe key, e.g., "regulatory_code"
  type           FieldType
  options        String[]  @default([]) // dropdown choices for SELECT type
  isRequired     Boolean   @default(false) @map("is_required")
  position       Int       @default(0)
  organizationId String    @map("organization_id")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, fieldKey])
  @@map("field_definitions")
}

enum FieldType {
  TEXT
  NUMBER
  SELECT
  DATE
  USER
}

// =============================================================================
// Board Columns (Fully Configurable NPD Pipeline)
// =============================================================================

model BoardColumn {
  id        String      @id @default(cuid())
  name      String
  position  Int
  wipLimit  Int?        @map("wip_limit") // null = unlimited
  colType   ColumnType  @default(TODO) @map("col_type")
  boardType BoardType   @default(SPRINT_BOARD) @map("board_type")
  projectId String      @map("project_id")
  createdAt DateTime    @default(now()) @map("created_at")

  project Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  stories UserStory[]

  @@unique([projectId, boardType, position])
  @@map("board_columns")
}

enum ColumnType {
  BACKLOG
  TODO
  DOING
  DONE
}

enum BoardType {
  GLOBAL_PRODUCT_BACKLOG
  SPRINT_BOARD
}

// =============================================================================
// Sprints (Iterations within a Project)
// =============================================================================

model Sprint {
  id             String       @id @default(cuid())
  name           String
  goal           String?      @db.Text
  startDate      DateTime?    @map("start_date")
  endDate        DateTime?    @map("end_date")
  status         SprintStatus @default(PLANNING)
  projectId      String       @map("project_id")
  organizationId String       @map("organization_id")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  project   Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  stories   UserStory[]
  snapshots SprintSnapshot[]

  @@index([projectId, status])
  @@index([organizationId])
  @@map("sprints")
}

enum SprintStatus {
  PLANNING
  ACTIVE
  CLOSED
}

model SprintSnapshot {
  id              String   @id @default(cuid())
  date            DateTime @db.Date
  totalPoints     Int      @default(0) @map("total_points")
  completedPoints Int      @default(0) @map("completed_points")
  totalValue      Int      @default(0) @map("total_value")
  completedValue  Int      @default(0) @map("completed_value")
  sprintId        String   @map("sprint_id")
  createdAt       DateTime @default(now()) @map("created_at")

  sprint Sprint @relation(fields: [sprintId], references: [id], onDelete: Cascade)

  @@unique([sprintId, date])
  @@map("sprint_snapshots")
}

// =============================================================================
// User Story (Backlog Item — the core work unit)
// e.g., "As R&D, I need to approve the 2nd nozzle trial..."
// =============================================================================

model UserStory {
  id             String      @id @default(cuid())
  number         Int
  title          String
  description    String?     @db.Text
  status         String      @default("BACKLOG")
  priority       String      @default("NONE")
  department     Department?
  position       Int         @default(0)

  // WSJF Scoring (Weighted Shortest Job First)
  userBusinessValue Int       @default(0) @map("user_business_value") // 1-10
  timeCriticality   Int       @default(0) @map("time_criticality")    // 1-10
  riskReduction     Int       @default(0) @map("risk_reduction")      // 1-10
  jobSize           Int       @default(1) @map("job_size")            // Story Points (>0)

  storyPoints    Int?        @map("story_points")
  metadata       Json?       @db.JsonB
  customValues   Json?       @db.JsonB @map("custom_values") // Dynamic field data from FieldDefinitions

  // Relations
  projectId      String      @map("project_id")
  featureId      String?     @map("feature_id")
  columnId       String?     @map("column_id")
  sprintId       String?     @map("sprint_id")
  assigneeId     String?     @map("assignee_id")
  reporterId     String      @map("reporter_id")
  organizationId String      @map("organization_id")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")
  archivedAt     DateTime?   @map("archived_at")

  project    Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  feature    Feature?     @relation(fields: [featureId], references: [id], onDelete: SetNull)
  column     BoardColumn? @relation(fields: [columnId], references: [id], onDelete: SetNull)
  sprint     Sprint?      @relation(fields: [sprintId], references: [id], onDelete: SetNull)
  assignee   User?        @relation("StoryAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  reporter   User         @relation("StoryReporter", fields: [reporterId], references: [id])

  tasks            Task[]
  checklists       ChecklistItem[]
  comments         Comment[]
  activities       Activity[]
  labels           StoryLabel[]
  attachments      Attachment[]
  estimationVotes  EstimationVote[]

  @@unique([projectId, number])
  @@index([organizationId])
  @@index([projectId, columnId])
  @@index([assigneeId])
  @@index([sprintId])
  @@index([featureId])
  @@map("user_stories")
}

// =============================================================================
// Task (Granular action within a User Story)
// e.g., "Order raw materials", "Schedule lab slot"
// =============================================================================

model Task {
  id          String    @id @default(cuid())
  title       String
  completed   Boolean   @default(false)
  position    Int       @default(0)
  storyId     String    @map("story_id")
  assigneeId  String?   @map("assignee_id")
  dueDate     DateTime? @map("due_date")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  story    UserStory @relation(fields: [storyId], references: [id], onDelete: Cascade)
  assignee User?     @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)

  @@map("tasks")
}

// =============================================================================
// Quality Gates: DoR (Definition of Ready) & DoD (Definition of Done)
// =============================================================================

model ChecklistItem {
  id        String        @id @default(cuid())
  title     String
  checked   Boolean       @default(false)
  type      ChecklistType
  position  Int           @default(0)
  storyId   String        @map("story_id")
  createdAt DateTime      @default(now()) @map("created_at")

  story UserStory @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@map("checklist_items")
}

enum ChecklistType {
  DOR // Definition of Ready — must be met before entering Sprint
  DOD // Definition of Done — must be met before closing / moving to Done
}

// =============================================================================
// Comments & Activity
// =============================================================================

model Comment {
  id        String   @id @default(cuid())
  body      String   @db.Text
  storyId   String   @map("story_id")
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  story UserStory @relation(fields: [storyId], references: [id], onDelete: Cascade)
  user  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("comments")
}

model Activity {
  id        String   @id @default(cuid())
  type      String
  data      Json?    @db.JsonB
  storyId   String   @map("story_id")
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  story UserStory @relation(fields: [storyId], references: [id], onDelete: Cascade)
  user  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([storyId])
  @@map("activities")
}

// =============================================================================
// Estimation / Planning Poker (Real-Time Collaborative Voting)
// =============================================================================

model EstimationSession {
  id             String               @id @default(cuid())
  name           String               @default("Estimation Session")
  accessCode     String               @unique @map("access_code")
  status         EstimationStatus     @default(WAITING)
  votingType     VotingType           @default(EFFORT)
  activeStoryId  String?              @map("active_story_id")
  projectId      String               @map("project_id")
  organizationId String               @map("organization_id")
  hostUserId     String               @map("host_user_id")
  createdAt      DateTime             @default(now()) @map("created_at")
  updatedAt      DateTime             @updatedAt @map("updated_at")

  project      Project                @relation(fields: [projectId], references: [id], onDelete: Cascade)
  hostUser     User                   @relation("SessionHost", fields: [hostUserId], references: [id])
  participants EstimationParticipant[]
  votes        EstimationVote[]

  @@index([accessCode])
  @@index([projectId])
  @@map("estimation_sessions")
}

model EstimationParticipant {
  id        String   @id @default(cuid())
  name      String // Display name (for guests or logged-in users)
  isHost    Boolean  @default(false) @map("is_host")
  userId    String?  @map("user_id") // null = guest participant
  guestId   String?  @map("guest_id") // localStorage-based guest ID
  sessionId String   @map("session_id")
  createdAt DateTime @default(now()) @map("created_at")

  user    User?              @relation(fields: [userId], references: [id], onDelete: SetNull)
  session EstimationSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  votes   EstimationVote[]

  @@unique([sessionId, guestId])
  @@index([sessionId])
  @@map("estimation_participants")
}

model EstimationVote {
  id            String   @id @default(cuid())
  value         Int // The vote value (1, 2, 3, 5, 8, 13, 20)
  participantId String   @map("participant_id")
  sessionId     String   @map("session_id")
  storyId       String   @map("story_id")
  createdAt     DateTime @default(now()) @map("created_at")

  participant EstimationParticipant @relation(fields: [participantId], references: [id], onDelete: Cascade)
  session     EstimationSession     @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  story       UserStory             @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@unique([participantId, sessionId, storyId])
  @@map("estimation_votes")
}

enum EstimationStatus {
  WAITING  // Waiting for host to pick a story
  VOTING   // Votes in progress
  REVEALED // Votes revealed
}

enum VotingType {
  EFFORT // Story Points / Job Size
  VALUE  // User Business Value
  TIME   // Time Criticality
  RISK   // Risk Reduction
}

// =============================================================================
// File Attachments (Lab results, PDFs, photos)
// =============================================================================

model Attachment {
  id        String   @id @default(cuid())
  name      String
  url       String
  size      Int
  mimeType  String   @map("mime_type")
  storyId   String   @map("story_id")
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  story UserStory @relation(fields: [storyId], references: [id], onDelete: Cascade)
  user  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("attachments")
}
