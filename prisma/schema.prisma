// =============================================================================
// Sprintify - Database Schema
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// =============================================================================
// Auth & Identity
// =============================================================================

model User {
  id         String   @id @default(cuid())
  supabaseId String   @unique @map("supabase_id")
  email      String   @unique
  name       String?
  avatarUrl  String?  @map("avatar_url")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  memberships     Membership[]
  assignedTickets Ticket[]     @relation("TicketAssignee")
  reportedTickets Ticket[]     @relation("TicketReporter")
  comments        Comment[]
  activities      Activity[]
  attachments     Attachment[]

  @@map("users")
}

// =============================================================================
// Organization & Tenancy
// =============================================================================

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  memberships Membership[]
  projects    Project[]
  labels      Label[]

  @@map("organizations")
}

model Membership {
  id             String   @id @default(cuid())
  role           Role     @default(MEMBER)
  userId         String   @map("user_id")
  organizationId String   @map("organization_id")
  createdAt      DateTime @default(now()) @map("created_at")

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@map("memberships")
}

enum Role {
  ADMIN
  MEMBER
  VIEWER
}

// =============================================================================
// Labels (Org-scoped, shared across projects)
// =============================================================================

model Label {
  id             String   @id @default(cuid())
  name           String
  color          String   @default("#6B7280")
  organizationId String   @map("organization_id")
  createdAt      DateTime @default(now()) @map("created_at")

  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  tickets      TicketLabel[]

  @@unique([organizationId, name])
  @@map("labels")
}

model TicketLabel {
  ticketId String @map("ticket_id")
  labelId  String @map("label_id")

  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  label  Label  @relation(fields: [labelId], references: [id], onDelete: Cascade)

  @@id([ticketId, labelId])
  @@map("ticket_labels")
}

// =============================================================================
// Projects & Boards
// =============================================================================

model Project {
  id             String   @id @default(cuid())
  name           String
  key            String
  description    String?  @db.Text
  organizationId String   @map("organization_id")
  ticketCounter  Int      @default(0) @map("ticket_counter")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  tickets      Ticket[]
  boardColumns BoardColumn[]
  sprints      Sprint[]

  @@unique([organizationId, key])
  @@map("projects")
}

model BoardColumn {
  id        String   @id @default(cuid())
  name      String
  position  Int
  projectId String   @map("project_id")
  createdAt DateTime @default(now()) @map("created_at")

  project Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tickets Ticket[]

  @@unique([projectId, position])
  @@map("board_columns")
}

// =============================================================================
// Sprints
// =============================================================================

model Sprint {
  id             String       @id @default(cuid())
  name           String
  goal           String?      @db.Text
  startDate      DateTime?    @map("start_date")
  endDate        DateTime?    @map("end_date")
  status         SprintStatus @default(PLANNING)
  projectId      String       @map("project_id")
  organizationId String       @map("organization_id")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  project   Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tickets   Ticket[]
  snapshots SprintSnapshot[]

  @@index([projectId, status])
  @@index([organizationId])
  @@map("sprints")
}

enum SprintStatus {
  PLANNING
  ACTIVE
  CLOSED
}

model SprintSnapshot {
  id              String   @id @default(cuid())
  date            DateTime @db.Date
  totalPoints     Int      @default(0) @map("total_points")
  completedPoints Int      @default(0) @map("completed_points")
  sprintId        String   @map("sprint_id")
  createdAt       DateTime @default(now()) @map("created_at")

  sprint Sprint @relation(fields: [sprintId], references: [id], onDelete: Cascade)

  @@unique([sprintId, date])
  @@map("sprint_snapshots")
}

// =============================================================================
// Tickets
// =============================================================================

model Ticket {
  id             String    @id @default(cuid())
  number         Int
  title          String
  description    String?   @db.Text
  status         String    @default("TODO")
  priority       String    @default("NONE")
  position       Int       @default(0)
  storyPoints    Int?      @map("story_points")
  metadata       Json?     @db.JsonB
  projectId      String    @map("project_id")
  columnId       String?   @map("column_id")
  sprintId       String?   @map("sprint_id")
  assigneeId     String?   @map("assignee_id")
  reporterId     String    @map("reporter_id")
  organizationId String    @map("organization_id")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  archivedAt     DateTime? @map("archived_at")

  project  Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  column   BoardColumn? @relation(fields: [columnId], references: [id], onDelete: SetNull)
  sprint   Sprint?      @relation(fields: [sprintId], references: [id], onDelete: SetNull)
  assignee User?        @relation("TicketAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  reporter User         @relation("TicketReporter", fields: [reporterId], references: [id])

  comments    Comment[]
  activities  Activity[]
  labels      TicketLabel[]
  attachments Attachment[]

  @@unique([projectId, number])
  @@index([organizationId])
  @@index([projectId, columnId])
  @@index([assigneeId])
  @@index([sprintId])
  @@map("tickets")
}

// =============================================================================
// Comments & Activity
// =============================================================================

model Comment {
  id        String   @id @default(cuid())
  body      String   @db.Text
  ticketId  String   @map("ticket_id")
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("comments")
}

model Activity {
  id        String   @id @default(cuid())
  type      String
  data      Json?    @db.JsonB
  ticketId  String   @map("ticket_id")
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@map("activities")
}

// =============================================================================
// File Attachments
// =============================================================================

model Attachment {
  id        String   @id @default(cuid())
  name      String
  url       String
  size      Int
  mimeType  String   @map("mime_type")
  ticketId  String   @map("ticket_id")
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("attachments")
}
